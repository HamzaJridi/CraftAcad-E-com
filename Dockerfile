FROM ubuntu:14.04MAINTAINER nihel <nihel.msilini@gmail.com>RUN apt-get update -yRUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv EA312927RUN echo "deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen" | tee /etc/apt/sources.list.d/mongodb-org-3.2.listRUN apt-get update -yRUN apt-get install mongodb-org -y --force-yesRUN mkdir -p /data/dbRUN locale-genRUN export LC_ALL=CRUN  service mongod startEXPOSE 27017RUN apt-get install curl -y --force-yesRUN apt-get install npm -y --force-yesRUN curl -sL https://deb.nodesource.com/setup_4.x |shRUN apt-get install -y nodejs --force-yesRUN apt-get install -y build-essentialRUN mkdir -p /opt/confd/bin /etc/confd/templates  /etc/confd/conf.d && \  curl -sLk https://github.com/kelseyhightower/confd/releases/download/v0.9.0/confd-0.9.0-linux-amd64 > /opt/confd/bin/confd && \  ln -s /opt/confd/bin/confd /bin/confd && \chmod +x /opt/confd/bin/confdRUN apt-get update -yRUN apt-get install haproxyRUN rm /etc/haproxy/haproxy.cfgRUN echo "[template] \n src=\"haproxy.cfg.tmpl\" \n dest=\"/etc/haproxy/haproxy.cfg\" \n keys=[ \n \"/hamza\" \n ]" > /etc/confd/conf.d/template.tomlRUN echo "global \n log /dev/log  local0 \n log /dev/log local1 notice \n chroot /var/lib/haproxy \n user haproxy \n group haproxy \n daemon \n defaults log global \n mode http \n option forwardfor \n option http-server-close \n option httplog \n	option	dontlognull \n contimeout 5000 \n clitimeout 50000 \n srvtimeout 50000 \n errorfile 400 /etc/haproxy/errors/400.http \n errorfile 403 /etc/haproxy/errors/403.http \n errorfile 408 /etc/haproxy/errors/408.http \n errorfile 500 /etc/haproxy/errors/500.http \n errorfile 502 /etc/haproxy/errors/502.http \n errorfile 503 /etc/haproxy/errors/503.http \n errorfile 504 /etc/haproxy/errors/504.http \n frontend http-frontend \n  bind 192.168.42.162:80 \n reqadd X-Forwarded-Proto:\ http \n default_backend wwwbackend \n backend wwwbackend \n server 1-www 127.0.0.1:{{getv \"/hamza\"}} check\n " > /etc/confd/templates/haproxy.cfg.tmplRUN service haproxy restartRUN echo "[template] \n src=\"run.sh.tmpl\" \n dest=\"/etc/init.d/run.sh\" \n keys=[\n \"/hamza\" \n ]" > /etc/confd/conf.d/run.sh.tomlRUN echo "#!/bin/bash \n node server.js > /dev/null & \n mongod > /dev/null  & \n service haproxy restart \n "> /etc/confd/templates/run.sh.tmplWORKDIR .COPY package.json ./RUN npm installCOPY . .COPY run.sh /usr/local/run.shEXPOSE 80CMD ["/bin/bash", "/usr/local/run.sh"]CMD ["confd", "-node 192.168.42.162:8500", "-backend consul", "-onetime"]